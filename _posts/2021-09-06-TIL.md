---
layout: post
title: "DRF"
date: 2021-09-06
categories: TIL Python DjangoRestFramework
---

# [DRF](https://www.django-rest-framework.org/)

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/DRF.png){: width="500" height="300"}

> DRFì˜ í° ê¸°ëŠ¥ì€ Modelsë¥¼ serializersë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. DRFì—ì„œ serializersëŠ” ë³µì¡í•œ êµ¬ì¡°ë“¤ì„ ì´ë¯¸ êµ¬ì„±í•´ë‘ì—ˆìŠµë‹ˆë‹¤. serializersëŠ” ëª¨ë¸ì„ ì „ë‹¬í•˜ê³ , ê·¸ ëª¨ë¸ë“¤ì„ json ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒë§Œì´ ì „ë¶€ê°€ ì•„ë‹™ë‹ˆë‹¤.

- ì§ë ¬í™” : ì¶”ìƒì ì¸ objectë¥¼ êµ¬ì²´ì ì´ê³ , ì €ì¥ê°€ëŠ¥í•˜ê³ , ì „ì†¡ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸íŒŒì¼ (ì—°ì†ëœ byteíŒŒì¼ = stream of bytes)ë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒ
- ì—­ì§ë ¬í™” : í…ìŠ¤íŠ¸íŒŒì¼(ì—°ì†ëœ byte íŒŒì¼ = stream of bytes)ë¥¼ ì§ë ¬í™”ëœ ë°ì´í„° í¬ë§·í˜•íƒœë¡œ ì¶”ìƒì ì¸ object ë°ì´í„°ë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒ

ì§ë ¬í™”, ì—­ì§ë ¬í™”ë¥¼ ë„ì™€ì£¼ë¯€ë¡œì¨ ê¸°ì¡´ì˜ Djangoì˜ ë¶ˆí¸í•œ ì ë“¤ì„ ë³´ì™„í•´ì£¼ì—ˆë‹¤

## ì‹œì‘

`pip install djangorestframework`

**settings.py**

```pyhon
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'corsheaders',
    'rest_framework',
]
ì¶”ê°€

REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        ...
    ],
    'PAGE_SIZE': 10
}
```

## Django íšŒì›ê°€ì… API, ë¡œê·¸ì¸ API

### urls.py

```python
from django.urls import path

from user.views import Signup, Signin

urlpatterns = [
    path('/signup', Signup.as_view()),
    path('/signin', Signin.as_view()),
]
```

### view.py

```python
class Signup(View):
    def post(self, request):
        data = json.loads(request.body)
        try:
            email        = data['email']
            password     = data['password']

            if not validate_email(email):
                return JsonResponse({'message':'INVALID EMAIL'}, status=400)

            if not validate_password(password):
                return JsonResponse({'message':'INVALID PASSWORD'}, status=400)

            if User.objects.filter(email = email).exists():
                return JsonResponse({'message':'DUPLICATE EMAIL'}, status=400)


            user = User.objects.create(
                email        = email,
                password     = bcrypt.hashpw(password.encode('utf-8'),bcrypt.gensalt()).decode('utf-8')
            )

            return JsonResponse({'message':'SUCCESS'}, status=200)
        except KeyError:
            return JsonResponse({'message':'KEY ERROR'}, status=400)

class Signin(View):
    def post(self, request):
        data = json.loads(request.body)
        try:
            email    = data['email']
            password = data['password'].encode('utf-8')

            if not User.objects.filter(email=email).exists():
                return JsonResponse({'message': 'INVALID_USER'}, status=401)

            user            = User.objects.get(email=email)
            user_password   = user.password.encode('utf-8')
            if not bcrypt.checkpw(password, user_password):
                return JsonResponse({'message': 'INVALID_USER'}, status=401)

            return JsonResponse({'message':'SUCCESS'}, status=200)

        except KeyError:
            return JsonResponse({'message':'KEYERROR'}, status=400)
```

## DRF íšŒì›ê°€ì… API, ë¡œê·¸ì¸ API

### urls.py

```python
from django.urls import path

from user.views import UserSignUpAPIView, UserSignInAPIView

urlpatterns = [
    path('/signup', UserSignUpAPIView.as_view()),
    path('/signin', UserSignInAPIView.as_view())
]
```

### views.py

```python
from rest_framework.response import Response
from rest_framework.generics import GenericAPIView
from rest_framework import status

from user.models import User
from user.serializers import UserSerializer

import bcrypt

class UserSignUpAPIView(GenericAPIView):
    serializer_class = UserSerializer

    def post(self, request):
        serializer = UserSerializer(data=request.data)

        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response({"message": "ok"}, status=status.HTTP_201_CREATED)

        return Response(serializer.errors, status = status.HTTP_400_BAD_REQUEST )

class UserSignInAPIView(GenericAPIView):
    serializer_class = UserSerializer

    def post(self, request):
        data = request.data
        email = data.get('email')
        password = data.get('password').encode('utf-8')

        if not User.objects.filter(email=email).exists():
            return Response(
                {'message': 'INVALID USER'},
                status = status.HTTP_400_BAD_REQUEST
            )

        user            = User.objects.get(email=email)
        user_password   = user.password.encode('utf-8')

        if not bcrypt.checkpw(password, user_password):
            return Response(
                {'message': 'INVALID USER'},
                status = status.HTTP_400_BAD_REQUEST
            )
        return Response({"message": "ok"}, status=status.HTTP_201_CREATED)
```

### serializers.py

```python
from user.models import User
from user.validate import validate_email, validate_password
from rest_framework.validators import UniqueValidator
from rest_framework import serializers

import bcrypt

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model  = User
        fields = ['email', 'password']
        extra_kwargs = {
                'email': {
                    'validators': [
                        UniqueValidator(
                            queryset=User.objects.all()
                        )
                    ]
                }
            }


    def save(self):
        email = self.validated_data['email']
        password = self.validated_data['password']

        password = bcrypt.hashpw(password.encode('utf-8'),bcrypt.gensalt()).decode('utf-8')
        print(password)
        user =  User(
                email        = email,
                password     = password
            )

        user.save()
        return { "user" : user }

    def validate(self, data):
        email = data.get('email', None)
        password = data.get('password', None)

        if not validate_email(email):
            raise serializers.ValidationError({'message':'INVALID EMAIL'})

        if not validate_password(password):
            raise serializers.ValidationError({'message':'INVALID PASSWORD'})

        if User.objects.filter(email = email).exists():
            raise serializers.ValidationError({'message':'DUPLICATE EMAIL'})

        return super().validate(data)
```

model fieldì— unique=Trueë¥¼ ë„£ìœ¼ë‹ˆ serializersì—ì„œ `user with this email already exists` ì—ëŸ¬ë¬¸êµ¬ë¡œ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ê²Œ ë˜ì–´ë²„ë ¸ë‹¤ uniqueë¶€ë¶„ì—ì„œ ê³„ì† ì–´ë– í•œ ì¶©ëŒì´ ì¼ì–´ë‚˜ëŠ” ê²ƒ ê°™ì€ë° ì´ìœ ë¥¼ ì°¾ì•„ë³´ì

### í•´ê²° ğŸ˜

```python
class UserSignInAPIView(GenericAPIView):
    serializer_class = UserSignInSerializer

    def post(self, request):
        email = request.data.get('email')
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response({'message': 'INVALID USER'}, status = status.HTTP_400_BAD_REQUEST )

        serializer = UserSignInSerializer(user, data=request.data)
        if not serializer.is_valid(raise_exception=True):
            return Response({'message': 'INVALID USER'}, status = status.HTTP_400_BAD_REQUEST )

        return Response(serializer.data['email'])
```

**í•´ë‹¹ userì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ì°¾ì•„ì„œ serializerì— ì „ë‹¬ì„ í•´ì¤€ë‹¤**

GenericAPIView, api_viewì— ëŒ€í•´ì„œë„ ì¡°ì‚¬ë¥¼ í•´ë³´ì
