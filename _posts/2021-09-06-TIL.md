---
layout: post
title: "DRF"
date: 2021-09-06
categories: TIL Python DjangoRestFramework
---

# [DRF](https://www.django-rest-framework.org/)

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/DRF.png){: width="500" height="300"}

> DRFì˜ í° ê¸°ëŠ¥ì€ Modelsë¥¼ serializersë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. DRFì—ì„œ serializersëŠ” ë³µì¡í•œ êµ¬ì¡°ë“¤ì„ ì´ë¯¸ êµ¬ì„±í•´ë‘ì—ˆìŠµë‹ˆë‹¤. serializersëŠ” ëª¨ë¸ì„ ì „ë‹¬í•˜ê³ , ê·¸ ëª¨ë¸ë“¤ì„ json ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒë§Œì´ ì „ë¶€ê°€ ì•„ë‹™ë‹ˆë‹¤.

- ì§ë ¬í™” : ì¶”ìƒì ì¸ objectë¥¼ êµ¬ì²´ì ì´ê³ , ì €ì¥ê°€ëŠ¥í•˜ê³ , ì „ì†¡ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸íŒŒì¼ (ì—°ì†ëœ byteíŒŒì¼ = stream of bytes)ë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒ
- ì—­ì§ë ¬í™” : í…ìŠ¤íŠ¸íŒŒì¼(ì—°ì†ëœ byte íŒŒì¼ = stream of bytes)ë¥¼ ì§ë ¬í™”ëœ ë°ì´í„° í¬ë§·í˜•íƒœë¡œ ì¶”ìƒì ì¸ object ë°ì´í„°ë¡œ ë°”ê¿”ì£¼ëŠ” ê²ƒ

ì§ë ¬í™”, ì—­ì§ë ¬í™”ë¥¼ ë„ì™€ì£¼ë¯€ë¡œì¨ ê¸°ì¡´ì˜ Djangoì˜ ë¶ˆí¸í•œ ì ë“¤ì„ ë³´ì™„í•´ì£¼ì—ˆë‹¤

## ì‹œì‘

`pip install djangorestframework`

**settings.py**

```pyhon
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'corsheaders',
    'rest_framework',
]
ì¶”ê°€

REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        ...
    ],
    'PAGE_SIZE': 10
}
```

## Django íšŒì›ê°€ì… API, ë¡œê·¸ì¸ API

### urls.py

```python
from django.urls import path

from user.views import Signup, Signin

urlpatterns = [
    path('/signup', Signup.as_view()),
    path('/signin', Signin.as_view()),
]
```

### view.py

```python
class Signup(View):
    def post(self, request):
        data = json.loads(request.body)
        try:
            email        = data['email']
            password     = data['password']

            if not validate_email(email):
                return JsonResponse({'message':'INVALID EMAIL'}, status=400)

            if not validate_password(password):
                return JsonResponse({'message':'INVALID PASSWORD'}, status=400)

            if User.objects.filter(email = email).exists():
                return JsonResponse({'message':'DUPLICATE EMAIL'}, status=400)


            user = User.objects.create(
                email        = email,
                password     = bcrypt.hashpw(password.encode('utf-8'),bcrypt.gensalt()).decode('utf-8')
            )

            return JsonResponse({'message':'SUCCESS'}, status=200)
        except KeyError:
            return JsonResponse({'message':'KEY ERROR'}, status=400)

class Signin(View):
    def post(self, request):
        data = json.loads(request.body)
        try:
            email    = data['email']
            password = data['password'].encode('utf-8')

            if not User.objects.filter(email=email).exists():
                return JsonResponse({'message': 'INVALID_USER'}, status=401)

            user            = User.objects.get(email=email)
            user_password   = user.password.encode('utf-8')
            if not bcrypt.checkpw(password, user_password):
                return JsonResponse({'message': 'INVALID_USER'}, status=401)

            return JsonResponse({'message':'SUCCESS'}, status=200)

        except KeyError:
            return JsonResponse({'message':'KEYERROR'}, status=400)
```

## DRF íšŒì›ê°€ì… API, ë¡œê·¸ì¸ API

### urls.py

```python
from django.urls import path

from user.views import UserSignUpAPIView, UserSignInAPIView

urlpatterns = [
    path('/signup', UserSignUpAPIView.as_view()),
    path('/signin', UserSignInAPIView.as_view())
]
```

### views.py

```python
from rest_framework.response import Response
from rest_framework.generics import GenericAPIView
from rest_framework import status

from user.models import User
from user.serializers import UserSerializer

import bcrypt

class UserSignUpAPIView(GenericAPIView):
    serializer_class = UserSerializer

    def post(self, request):
        serializer = UserSerializer(data=request.data)

        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response({"message": "ok"}, status=status.HTTP_201_CREATED)

        return Response(serializer.errors, status = status.HTTP_400_BAD_REQUEST )

class UserSignInAPIView(GenericAPIView):
    serializer_class = UserSerializer

    def post(self, request):
        data = request.data
        email = data.get('email')
        password = data.get('password').encode('utf-8')

        if not User.objects.filter(email=email).exists():
            return Response(
                {'message': 'INVALID USER'},
                status = status.HTTP_400_BAD_REQUEST
            )

        user            = User.objects.get(email=email)
        user_password   = user.password.encode('utf-8')

        if not bcrypt.checkpw(password, user_password):
            return Response(
                {'message': 'INVALID USER'},
                status = status.HTTP_400_BAD_REQUEST
            )
        return Response({"message": "ok"}, status=status.HTTP_201_CREATED)
```

### serializers.py

```python
from user.models import User
from user.validate import validate_email, validate_password
from rest_framework.validators import UniqueValidator
from rest_framework import serializers

import bcrypt

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model  = User
        fields = ['email', 'password']
        extra_kwargs = {
                'email': {
                    'validators': [
                        UniqueValidator(
                            queryset=User.objects.all()
                        )
                    ]
                }
            }


    def save(self):
        email = self.validated_data['email']
        password = self.validated_data['password']

        password = bcrypt.hashpw(password.encode('utf-8'),bcrypt.gensalt()).decode('utf-8')
        print(password)
        user =  User(
                email        = email,
                password     = password
            )

        user.save()
        return { "user" : user }

    def validate(self, data):
        email = data.get('email', None)
        password = data.get('password', None)

        if not validate_email(email):
            raise serializers.ValidationError({'message':'INVALID EMAIL'})

        if not validate_password(password):
            raise serializers.ValidationError({'message':'INVALID PASSWORD'})

        if User.objects.filter(email = email).exists():
            raise serializers.ValidationError({'message':'DUPLICATE EMAIL'})

        return super().validate(data)
```

model fieldì— unique=Trueë¥¼ ë„£ìœ¼ë‹ˆ serializersì—ì„œ `user with this email already exists` ì—ëŸ¬ë¬¸êµ¬ë¡œ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•˜ê²Œ ë˜ì–´ë²„ë ¸ë‹¤ uniqueë¶€ë¶„ì—ì„œ ê³„ì† ì–´ë– í•œ ì¶©ëŒì´ ì¼ì–´ë‚˜ëŠ” ê²ƒ ê°™ì€ë° ì´ìœ ë¥¼ ì°¾ì•„ë³´ì

### í•´ê²° ğŸ˜

```python
class UserSignInAPIView(GenericAPIView):
    serializer_class = UserSignInSerializer

    def post(self, request):
        email = request.data.get('email')
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response({'message': 'INVALID USER'}, status = status.HTTP_400_BAD_REQUEST )

        serializer = UserSignInSerializer(user, data=request.data)
        if not serializer.is_valid(raise_exception=True):
            return Response({'message': 'INVALID USER'}, status = status.HTTP_400_BAD_REQUEST )

        return Response(serializer.data['email'])
```

**í•´ë‹¹ userì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¨¼ì € ì°¾ì•„ì„œ serializerì— ì „ë‹¬ì„ í•´ì¤€ë‹¤**

## **@api_view, APIView -> generics.\* -> ViewSet**

```python
from rest_framework.views import APIView
from rest_framework.decorators import api_view
from rest_framework import generics
from rest_framework import viewsets
```

- @api_view : FBV í•¨ìˆ˜ê¸°ë°˜
- APIView : CBV í´ë˜ìŠ¤ê¸°ë°˜

- Mixins
  - CreateModelMixin : create()
  - ListModelMixin : list()
  - RetrieveModelMixin : retrieve()
  - UpdateModelMixin : update()
  - DestroyModelMixin : destroy()

```python
from rest_framework import generics
from rest_framework import mixins

class UserListAPIView(mixins.ListModelMixin, mixins.CreateModelMixin, generics.GenericAPIView):
```

- generics
  - generics.CreateAPIView : ìƒì„±
  - generics.ListAPIView : ëª©ë¡
  - generics.RetrieveAPIView : ì¡°íšŒ
  - generics.DestroyAPIView : ì‚­ì œ
  - generics.UpdateAPIView : ìˆ˜ì •
  - generics.RetrieveUpdateAPIView : ì¡°íšŒ/ìˆ˜ì •
  - generics.RetrieveDestroyAPIView : ì¡°íšŒ/ì‚­ì œ

```python
from rest_framework import generics

class UserListAPIView(generics.ListAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer
```

- ViewSet
  - viewsets.ReadOnlyModelViewSet : ëª©ë¡ ì¡°íšŒ, íŠ¹ì • ë ˆì½”ë“œ ì¡°íšŒ => 2ê°œì˜ URL ì§€ì›
  - viewsets.ModelViewSet : ëª©ë¡ ì¡°íšŒ, ìƒì„±, íŠ¹ì • ë ˆì½”ë“œ ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œ => 2ê°œì˜ URL ì§€ì›

### viewset.py

```python
from rest_framework import viewsets

class UserViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer

user_list = UserViewSet.as_view({
    'get': 'list',  # í˜¸ì¶œë  í•¨ìˆ˜ì™€ í˜¸ì¶œí•  í•¨ìˆ˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
})

user_detail = UserViewSet.as_view({
    'post': 'create',
})

```

### urls.py

```python
urlpatterns = [
    url("/user", user_list),
    url("/user/<int:pk>", user_detail),
]
```

## Router

- Viewsetë§Œ ë“±ë¡ì´ ê°€ëŠ¥í•˜ë‹¤
- Api Rootë¥¼ ì œê³µí•´ì¤€ë‹¤

### urls.py

```python
from rest_framework.routers import DefaultRouter

router = DefaultRouter()
router.register("user", views.UserViewSet)

# ì•„ë˜ì²˜ëŸ¼ ë“±ë¡í•˜ë©´ ê²°êµ­ì—” ê° urlì´ user/, user/<pk>ì´ëŸ° Urlì— ëŒ€ì‘í•˜ëŠ”ê²ƒì„ ë§Œë“¤ì–´ì¤Œ
urlpatterns = [
    url('/user', include(router.urls)),
]
```

ë””í´íŠ¸ ë§¤í•‘

- list route

  - url : /prefix/
  - name : {model name}-list , ë‹¨ model name ì€ ì†Œë¬¸ìì…ë‹ˆë‹¤.
  - 'get': 'list' 'post': 'create'

- detail route
  - url : /prefix/pk/
  - name : {model name}-detail
  - 'get': 'retrieve', 'put': 'update', 'patch': 'partial_update', 'delete': 'destroy',

## ì¶”ê°€ì ìœ¼ë¡œ ë§¤í•‘í•˜ê¸° - action

```python
from rest_framework.decorators import action
```

detail

- `detail=True`

  - url : /prefix/{pk}/{function name}/
  - name : {model name}-{function name}

- `detail=False`

  - url : /prefix/{function name}/ - name : {model name}-{function name}

### views.py - ì˜ˆì‹œ

```python
from rest_framework.viewsets import ReadOnlyModelViewSet, ModelViewSet
from rest_framework.decorators import action
from rest_framework.response import Response
from user.models import USer
from user.serializers import UserSerializer

class UserViewSet(ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer

    # url : user/public_list/
    @action(detail=False)
    def public_list(self, request):
        qs = self.queryset.filter(is_public=True)
        serializer = self.get_serializer(qs, many=True)
        return Response(serializer.data)

    # url : user/{pk}/set_public/
    @action(detail=True, methods=['patch'])
    def set_public(self, request, pk):
        instance = self.get_object()
        instance.is_public = True
        instance.save()
        serializer = self.get_serializer(instance)
        return Response(serializer.data)
```

[DRF ê¸°ë³¸í¸ 3](https://www.lostcatbox.com/2020/01/11/DRF03/)
[[Django] ViewSet ê³¼ Router](https://ssungkang.tistory.com/entry/Django-ViewSet-%EA%B3%BC-Router)
