---
layout: post
title: "Prisma Query Builder"
date: 2021-12-17
categories: TIL Prisma
---

<img src="https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/JOIN%20SQL.png" width="650" height="650">

- Join

```typescript
prisma.foo.findAll({
  include: {
    bar: true,
  },
  select: {
    baz: true,
  },
});
```

- having,

- group by [by]

- where

- distinct

- aggregate [_avg, _count]

```sql
SELECT A.* , B.id, B.name, B.age, B.email, C.content, C.id, C.like
FROM post as A
LEFT JOIN(SELECT COUNT(age) AS age_count, SUM(hight) AS hight_sum, SUM(weight) AS weight_count, user_uuid
        FROM user
        GROUP BY user_uuid) B
ON A.id = B.id
INNER JOIN user as B
ON A.user_uuid = B.user_uuid
LEFT OUTER JOIN foo E
ON A.post_uuid = E.post_uuid
WHERE A.user_uuid = uuid
```

```typescript
async function builderTest2(data) {
    const postList = await this.prismaService.post.findMany({});
    const commentList = await Promise.all(
      postList.map((post) => {
        return this.prismaService.comment.groupBy({
          by: ['post_uuid'],
          where: { post_uuid: post.post_uuid },
          _sum: {
            likes: true,
            count: true,
          },
        });
      }),
    ).then((comment) =>
      comment.filter((obj) => Array.isArray(obj) && obj.length > 0),
    );
    const leftjoin = await Promise.all(
      commentList.map(async (comment) => {
        const { post_uuid, _sum } = comment[0];
        return Object.assign(
          _sum,
          await this.prismaService.post.findFirst({
            where: { post_uuid },
          }),
        );
      }),
    );
    const innerjoin = await Promise.all(
      leftjoin.map(async (obj) => {
        const { user_uuid, ...result } = obj;
        return Object.assign(
          result,
          await this.prismaService.user.findFirst({
            where: { user_uuid },
          }),
        );
      }),
    );
    const outerjoin = await Promise.all(
      innerjoin.map(async (obj) => {
        const { post_uuid, ...result } = obj;
        return Object.assign(
          result,
          await this.prismaService.foo.findFirst({
            where: { post_uuid },
          }),
        );
      }),
    );
    return outerjoin;
```
