---
layout: post
title: "DockerSwarm ê¸°ì´ˆğŸ’¬"
date: 2021-10-01
categories: TIL Docker-machine DockerSwarm
---

# Docker-machine

ë¡œì»¬ì»´í“¨í„°ê°€ ë°°í¬ëœ ë„ì»¤ì™€ ë²„ì „ì´ ë‹¤ë¥¼ê²½ìš° dockermachineì„ í†µí•œ VMìœ¼ë¡œ ê°œë°œì„ í•  ìˆ˜ê°€ ìˆë‹¤  
ë¡œì»¬ì»´í“¨í„°ê°€ ì˜ì¡´ì ì´ì§€ ì•ŠëŠ” ìƒí™©ìœ¼ë¡œ ë§Œë“¤ì–´ì¤Œìœ¼ë¡œì¨ í¸ë¦¬í•¨ì„ ì œê³µí•´ì¤€ë‹¤

ì§€ê¸ˆì€ Docker-machineì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ í•˜ì§€ë§Œ í˜„ì¬ê¹Œì§€ ê°œë°œê³¼ì •ì—ì„œëŠ” ë§ì´ ì‚¬ìš©ë˜ê³  ìˆë‹¤  
[Deprecated Engine Features | Docker Documentation](https://docs.docker.com/machine/)  
[Deprecate Docker Machine Â· Issue](https://github.com/docker/roadmap/issues/245)

# DockerSwarm

## composeì™€ swarm ì—°ê²°íë¦„

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmflow.jpg)

ìµœì†Œí•œ 2ê°œì˜ ë…¸ë“œê°€ í•„ìš”í•˜ë‹¤

í•˜ë‚˜ì˜ ë…¸ë“œëŠ” manage(leader)ë…¸ë“œì´ê³  ë‹¤ë¥¸ í•˜ë‚˜ëŠ” workerë…¸ë“œë¡œ ì„¤ì •í•˜ì—¬  
EC2ì— ë§Œë“¤ì–´ ë†“ì•˜ë‹¤

ê° ë…¸ë“œ ì—°ê²°ì€ `2377 port`ë¡œ ì—°ê²°ì´ ëœë‹¤

## Docker swarm ê³¼ì •

1. `docker swarm init`
   ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarminit1.png)  
   leader ë…¸ë“œì—ì„œ docker swarmì„ ì´ˆê¸°í™” ë° ì‹¤í–‰ì„ ì‹œí‚¨ë‹¤

   - leader node í™•ì¸
     ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarminit.png)

2. `docker swarm init`ì„ ì‹¤í–‰í•˜ë©´ `docker swarm join --token ~~`ì´ ì¶œë ¥ì´ ëœë‹¤ ì´ê²ƒì„ ë³µì‚¬í•˜ì—¬ worker ë…¸ë“œì— ë¶™ì—¬ë„£ê³  ì‹¤í–‰ì„ í•œë‹¤
   ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarmjoin1.png)
   - worker node í™•ì¸
     ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarmjoin.png)
3. `docker stack deploy -c docker-compose.yml web`ìœ¼ë¡œ docker swarmì„ ì‹¤í–‰í•œë‹¤

```
Creating service web_{docker_service}
Creating service web_{docker_service2}
```

### docker-compose.yml

```
version: "3"

services:
  server:
    # docekrfile ê²½ë¡œ
    image: tree0204/drf_tuto:latest
    # build ê²½ë¡œ
    build: ./
    volumes:
      - ./:/usr/src/app
    command:
      - bash
      - -c
      - |
        python manage.py collectstatic --no-input
        python manage.py migrate
    ports:
      - 8000:8000
    depends_on:
      - sqlite3
    # docker swarmì´ deployë¶€ë¶„ì„ ì½ê³  ì‹¤í–‰í•œë‹¤
    deploy:
      placement:
        # í•´ë‹¹ ë…¸ë“œ ì—­í•  ë¶€ì—¬
        constraints:
          - node.role==manager
      # 3ê°œì˜ ì„œë²„ë¥¼ ëŒë¦°ë‹¤
      replicas: 3
      resources:
        limits:
          # ì„œë²„ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒì€ 0.1ì´ˆë¡œ ë‘ê³  memoryëŠ” 20Mbìœ¼ë¡œ ì„¤ì •
          cpus: "0.1"
          memory: 20M
      # ì„œë²„ê°€ ë‹¤ìš´ì´ ë˜ë©´ ëŒ€ì²´ë  ì˜ˆë¹„ ì»¨í…Œì´ë„ˆë“¤ì„ ì„¤ì •ì„ í•´ì¤€ë‹¤
      restart_policy:
        condition: on-failure
        delay: 2s
        max_attempts: 3

  sqlite3:
    image: nouchka/sqlite3:latest
    stdin_open: true
    tty: true
    volumes:
      - ./:./db.sqlite3
    deploy:
      replicas: 3
```

docker swarmì—ì„œëŠ” buildì˜ ëª…ë ¹ì–´ê°€ skipì´ ëœë‹¤

docker-composeì—ì„œëŠ” deployì˜ ëª…ë ¹ì–´ê°€ skipì´ ëœë‹¤

### Error

í˜„ì¬ í•´ë‹¹ docker-composeë¥¼ ì‹¤í–‰í•˜ë©´ì„œ ë¬¸ì œì ì´ ë°œìƒí•˜ì˜€ëŠ”ë°
í•œ ë…¸ë“œë¡œë§Œ ì‹¤í–‰ì„ í•  ë•ŒëŠ” ë¬¸ì œê°€ ì—†ë˜ ê²Œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚¬ìš©í•˜ë‹ˆ ê²½ë¡œë¬¸ì œê°€ ë°œìƒí•˜ì˜€ë‹¤  
volumeì˜ ê²½ë¡œì— ëŒ€í•œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ëŠ”ë° í•´ë‹¹ ì—ëŸ¬ë‚´ìš©ì€ ì´ë ‡ë‹¤

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror.png)

ë§ˆìš´íŠ¸ë˜ëŠ” DB voluemì˜ ê²½ë¡œê°€ ì˜ëª»ë˜ì–´ ë‚˜ì˜¤ëŠ” ë¬¸ì œë¼ê³  ìƒê°ì´ ëœë‹¤
í•´ë‹¹ ë¬¸ì œë¥¼ ê³ ì¹˜ê¸°ìœ„í•´ì„œëŠ” í´ëŸ¬ìŠ¤í„° ìš´ì˜ì— ëŒ€í•œ ê³ ë¯¼ì„ í•´ë´ì•¼ê² ë‹¤  
ì•„ì§ ì •í™•íˆ ì´í•´ê°€ ë˜ì§€ ì•ŠëŠ” ë¬¸ì œì—¬ì„œ ë‚œê´€ì— ë¶€ë”ªí˜”ë‹¤  
ê·¸ë¦¬ê³  ì—¬ëŸ¬ê°œì˜ ë…¸ë“œê°€ ìˆì„ ì‹œ DBì— ì €ì¥ë˜ëŠ” ë°ì´í„°ê°’ë“¤ì´ ë³€í˜•ì´ ë˜ê±°ë‚˜ ì‚­ì œê°€ ë˜ì§€ ì•Šê²Œ í•˜ê¸°ìœ„í•´ì„œëŠ” ë©”ì¸ ë…¸ë“œì— ë°ì´í„°ê°€ ì €ì¥ì´ ë˜ì–´ì•¼ í•œë‹¤ê³  ìƒê°í•œë‹¤  
ê·¸ëŸ¬í•œ ë¬¸ì œì— ëŒ€í•´ì„œëŠ” ì–´ë–»ê²Œ í•´ì•¼ë˜ëŠ”ì§€ ê²€ìƒ‰ì„ í•´ë³´ì•˜ëŠ”ë° NFS(Network FileSystem)ì„ ì‚¬ìš©í•œë‹¤ê³  ë‚˜ì™€ ìˆì—ˆë‹¤ ì´ê²ƒì— ëŒ€í•´ì„œë„ ê³µë¶€ë¥¼ í•´ë³´ì•„ì•¼ê² ë‹¤

- ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ë‹«íŒ ìƒí™©
  ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror4.png)
- ê°•ì œ ì—…ë°ì´íŠ¸ë¡œ ë‹¤ì‹œ ì‹¤í–‰ì„ í•´ë³´ì•˜ì§€ë§Œ
  ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror2.png)
- DB ì„œë¹„ìŠ¤ëŠ” ê³„ì† shutdownìƒíƒœê°€ ë˜ê³  ê²°êµ­ì—ëŠ” app serviceëŠ” ëª¨ë‘ ì¢…ë£Œê°€ ë˜ì–´ì„œ ì²˜ìŒ ìƒíƒœê°€ ë˜ë²„ë ¸ë‹¤
  ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror5.png)

## ê¸°íƒ€ ëª…ë ¹ì–´

- ëª¨ë“  Docker serviceì˜ ìƒí™© ì¶œë ¥
  `docker service ls`
- Docker serviceì˜ ìƒí™© ì¶œë ¥
  `docker service ps {service_name}`
- Docker serviceì˜ ì—ëŸ¬ì‚¬í•­ì„ í¬ë§·íŒ…ìœ¼ë¡œ ì¶œë ¥  
   `docker service ps --format "{{.Error}}" {service_name}`
- Docker service ê²€ì‚¬
  `docker service inspect {service_name}`
- Docker service ë¡œê·¸ í™•ì¸
  `docker service logs {service_name}`
- Docker service ì‚­ì œ
  `docker service rm {service_name}`
- Docker service ì—…ë°ì´íŠ¸
  `docker service update`
