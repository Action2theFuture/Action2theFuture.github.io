---
layout: post
title: "Prometheus ê¸°ì´ˆğŸ’¬"
date: 2021-10-06
categories: TIL Prometheus Jenkins
---

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/prometheus.png)

# Prometheus Architecture

![ì¶œì²˜:https://danawalab.github.io/common/2020/03/16/Common-Prometheus.html](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/prometheus2.png)

# Prometheus

ìœ ì—°í•œ ì¿¼ë¦¬ ë° ì‹¤ì‹œê°„ ê²½ê³ ì™€ í•¨ê»˜ HTTP í’€ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ êµ¬ì¶• ëœ ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤ì— ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ìŠ¤ì„ ê¸°ë¡í•˜ê³  ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ê³¼ ê²½ê³ ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì´ë‹¤

## Prometheus ê³¼ì •

djangoì™€ ì—°ë™í•˜ê¸° ìœ„í•´ì„œ ëª¨ë“ˆì„ ì„¤ì¹˜í•œë‹¤

`pip install django-prometheus`ë¥¼ ì„¤ì¹˜í•˜ê³  settings.pyì™€ urls.pyì— í•´ë‹¹ ë‚´ìš©ì„ ì ì–´ì¤€ë‹¤

### settings.py

```python
INSTALLED_APPS = [
    .
    .
    .
    'django_prometheus'
]

MIDDLEWARE = [
    'django_prometheus.middleware.PrometheusBeforeMiddleware',
    .
    .
    .
    'django_prometheus.middleware.PrometheusAfterMiddleware',
]
```

### urls.py

```python
urlpatterns = [
    .
    .
    .
    path('', include('django_prometheus.urls')),
]

```

middlewareë¥¼ í†µí•˜ì—¬ django_prometheus ëª¨ë“ˆì„ httpë¥¼ í†µí•œ ë°ì´í„°ë¥¼ ì½ì–´ metricsë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤  
`/metrics`ë¥¼ í†µí•˜ì—¬ í•´ë‹¹ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆë‹¤

## Docker-composeì™€ ì—°ë™

### docker-compose.yml

```docker-compose.yml
prometheus:
    image: prom/prometheus:latest
    # image pull
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    # prometheus í´ë” ì•ˆì— ìˆëŠ” prometheus.ymlì„ bindí•˜ì—¬ ë³¼ë¥¨ì—°ê²°ì„ í•´ì¤€ë‹¤
    # ì‚¬ë¼ì§ˆ ìˆ˜ ìˆëŠ” dataë“¤ì„ ìœ„í•´ prometheusì— ë³¼ë¥¨ bindí•œë‹¤
    command:
      - "--web.listen-address=0.0.0.0:9099"
      # 9099ì— í¬íŠ¸ë¥¼ ì—°ë‹¤
      - "--config.file=/etc/prometheus/prometheus.yml"
      # í™˜ê²½ì„¤ì • íŒŒì¼
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
    ports:
      - 9099:9099
    networks:
      - network
```

### prometheus.yml

```prometheus.yml
# my global config
global:
  scrape_interval: 15s
  # 15ì´ˆ ë§ˆë‹¤ scrape. Default is every 1 minute.
  evaluation_interval: 15s
  # 15ì´ˆ ë§ˆë‹¤ Evaluate rules . The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# ê²½ê³  ë§¤ë‹ˆì € ì„¤ì •
alerting:
  alertmanagers:
    - sheme: http
    - static_configs:
        - targets:
          - alertmanager:9093

# ì²˜ìŒì— í•œë²ˆ rule_filesë¥¼ ì½ê³  evaluation_interval ì„¤ì •ì— ë”°ë¼ ì‘ë™í•œë‹¤
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# ì‹¤ì œë¡œ ë‚˜íƒ€ë‚˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì§€ì •í•œë‹¤
# í”„ë¡œí† ì½œì˜ ê¸°ë³¸ê°’ì€ httpì´ë‹¤

scrape_configs:
  - job_name: "prometheus"

    static_configs:
      - targets: ["0.0.0.0:9099"]
  # 9099 promet
  # Exporter ì„¤ì •
  - job_name: "server"

    scrape_interval: 5s
    dns_sd_configs:
      - names:
          - "tasks.server"
        type: "A"
        port: 8000
    # docker swarm dnsì˜ 8000í¬íŠ¸ë¥¼ ê¸ì–´ì˜¨ë‹¤
```

## Prometheus ì‹¤í–‰

## Target Status

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/prometheus3.png)

## Graph

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/prometheus4.png)

## directory path

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/tree.png)

## Blocker

imagesì™€ buildë¥¼ ë™ì‹œì— í•˜ì—¬ ì¶©ëŒì´ ì¼ì–´ë‚˜ prometheusì— ì¶œë ¥ì´ ì•ˆë˜ëŠ” ë¬¸ì œ : docker-compose.ymlì— bulid ì»¤ë§¨ë“œ ì‚­ì œ, dockerhubì— ì´ë¯¸ì§€ push  
jenkinsì— docker permissionì„ ì œê³µí•˜ì§€ ì•Šì•„ì„œ docker buildê°€ ì•ˆë˜ëŠ” ë¬¸ì œ : usermod -aG docker jenkinsë¡œ í•´ê²° ë‚˜ì¤‘ì— ì‹¤í–‰í•  ë•ŒëŠ” configì— ì„¤ì •ì„ í•´ì£¼ì–´ì•¼ ê² ë‹¤  
docker serviceì™€ prometheusê°€ ì—°ë™ì´ ì•ˆë˜ëŠ” ë¬¸ì œ : djangoì— ë¯¸ë“¤ì›¨ì–´(django-prometheus)ë¥¼ ì‚½ì…ì„ í•˜ë‹ˆ í•´ê²°
Prometheusì˜ ë°ì´í„°ì˜ íœ˜ë°œì„± ë°©ì§€ : volumes í´ë”ë¥¼ bindí•˜ì—¬ í•´ê²°

[ì°¸ê³  Github](https://github.com/vegasbrianc/prometheus)
[ì°¸ê³  Site](https://www.sipios.com/blog-tech/monitoring)
