---
layout: post
title: "Celery ê¸°ì´ˆğŸ’¬"
date: 2021-11-09
categories: TIL Celery Redis
---

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/celery.png)

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/celery_process.jpeg)

Celery, Redis ë¹„ë™ê¸° ì‘ì—… í(Queue)

í˜„ì¬ í”„ë¡œì íŠ¸ ìƒí™©ì—ì„œ ì—…ë¡œë“œë˜ëŠ” ê³¼ì •ì—ì„œ ì†Œìš”ë˜ëŠ” ì‹œê°„ì´ ì‚¬ìš©ìì…ì¥ì—ì„œëŠ” ë¶ˆí¸í•˜ì—¬  
ë¹„ë™ê¸° ì‘ì—…ìœ¼ë¡œ ë”°ë¡œ ì„œë²„ë¥¼ êµ¬ì¶•ì„ í•˜ì—¬ì„œ ì´ìš©í•˜ë©´ ì–´ë–¨ê¹Œí•´ì„œ Celeryì— ëŒ€í•´ ì¡°ì‚¬ë¥¼ í•´ë³´ì•˜ë‹¤

CeleryëŠ” Workerì™€ Brokerë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤

## celery config

```python
CELERY_BROKER_URL = 'redis://localhost:6379/0'
BACKEND_URL = 'redis://localhost:6379/0'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'

from __future__ import absolute_import, unicode_literals
from celery import Celery
from settings import CELERY_BROKER_URL, BACKEND_URL

app = Celery("celery_app",broker=CELERY_BROKER_URL, backend=BACKEND_URL)
```

### app.config_from_object í™œìš©í•˜ê¸°

*celeryconfig.py*
```python
broker_url = 'redis://localhost:6379'
result_backend = 'redis://localhost:6379'
accept_content = ['pickle','json','application/x-python-serialize']
task_serializer = 'pickle'
result_serializer = 'pickle'
timezone = 'Asia/Seoul'
```

*celery_app/worker.py*
```python
from __future__ import absolute_import, unicode_literals
from celery import Celery

app = Celery('celery_app',include=['celery_app.tasks'])

app.config_from_object('celery_app.celeryconfig')
```

## Task
*celery_app/tasks.py*
```python
from celery_app.worker import app as celery_app

@celery_app.task
def add(x,y):
    return x+y
```

[Celery Task](https://docs.celeryproject.org/en/stable/userguide/tasks.html)

*â€» Task Process ì „ë‹¬*
- Task functionì— Process ì „ë‹¬ì„ í•˜ë ¤ë©´ í•´ë‹¹ ê°ì²´ê°€ Celery ì„¤ì •ëœ ë°ì´í„°í˜•ì‹ì— ì§ë ¬í™”ê°€ ê°€ëŠ¥í•´ì•¼í•œë‹¤
    - [Json](https://www.json.org/json-en.html) : JSONì˜ ì£¼ìš” ë‹¨ì ì€ ë¬¸ìì—´, ìœ ë‹ˆì½”ë“œ, ë¶€ë™ ì†Œìˆ˜ì , Bool, ë”•ì…”ë„ˆë¦¬ì™€ ë¦¬ìŠ¤íŠ¸ì™€ ê°™ì€ ë°ì´í„° ìœ í˜•ìœ¼ë¡œ ì œí•œëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. 
    ì†Œìˆ˜ì ê³¼ ë‚ ì§œ ë¶ˆê°€ëŠ¥ 
    ë°”ì´ë„ˆë¦¬ ë°ì´í„°ëŠ” Base64 ì¸ì½”ë”©ì„ ì‚¬ìš©í•˜ì—¬ ì „ì†¡ë˜ë©°, ê¸°ë³¸ ë°”ì´ë„ˆë¦¬ ìœ í˜•ì´ ì§€ì›ë˜ëŠ” ì¸ì½”ë”© í˜•ì‹ì— ë¹„í•´ ì „ì†¡ë˜ëŠ” ë°ì´í„°ì˜ í¬ê¸°ê°€ 34% ì¦ê°€í•©ë‹ˆë‹¤  
    ê·¸ëŸ¬ë‚˜ ë°ì´í„°ê°€ ìœ„ì˜ ì œì•½ ì¡°ê±´ì— ì í•©í•˜ê³  ì–¸ì–´ ê°„ ì§€ì›ì´ í•„ìš”í•œ ê²½ìš° JSONì˜ ê¸°ë³¸ ì„¤ì •ì´ ê°€ì¥ ì¢‹ì€ ì„ íƒì¼ ê²ƒì…ë‹ˆë‹¤  
    - [pickle](https://docs.python.org/dev/library/pickle.html#module-pickle) : ë‚´ì¥ëœ ëª¨ë“  Python ë°ì´í„° ìœ í˜•(í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ì œì™¸)
     ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ë³´ë‚¼ ë•Œ ë” ì‘ì€ ë©”ì‹œì§€, JSON ì²˜ë¦¬ì— ë¹„í•´ ì•½ê°„ì˜ ì†ë„ í–¥ìƒì„ ì§€ì›í•©ë‹ˆë‹¤
    - [yaml](http://yaml.org/) : ë” ë§ì€ ë°ì´í„° ìœ í˜•(ë‚ ì§œ, ì¬ê·€ ì°¸ì¡° ë“± í¬í•¨)ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤    
    AMLìš© Python ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” JSONìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ë³´ë‹¤ ì•½ê°„ ëŠë¦½ë‹ˆë‹¤.  
    ë³´ë‹¤ í‘œí˜„ì ì¸ ë°ì´í„° ìœ í˜• ì§‘í•©ì´ í•„ìš”í•˜ê³  ì–¸ì–´ ê°„ í˜¸í™˜ì„±ì„ ìœ ì§€í•´ì•¼ í•˜ëŠ” ê²½ìš° YAMLì´ ìœ„ì˜ ê²ƒë³´ë‹¤ ë” ì í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - [msgpack](http://msgpack.org/) :  msgpackì€ JSONì— ê°€ê¹Œìš´ ë°”ì´ë„ˆë¦¬ ì§ë ¬í™” í˜•ì‹ì…ë‹ˆë‹¤.

## Celery ë™ì‘
*main.py*
```python
from celery_app.tasks import add

add.apply_async(args=[1,2], link=callback_handler, link_error=error_handler, ....)
# ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ì½œë°±í•¨ìˆ˜ë¥¼ ì¸ìê°’ìœ¼ë¡œ ë„£ì„ ìˆ˜ ìˆë‹¤
```

### Callback Function

*ì˜ˆì‹œ*
```python
@celery_app.task
def error_handler(request, exc, traceback):
    print('Task {0} raised exception: {1!r}\n{2!r}'.format(
          request.id, exc, traceback))

@celery_app.task
def callback_handler(response):
   print(f"Success file count :: {response}")
```

Celery ì‹¤í–‰ ëª…ë ¹ì–´
`celery -A {file name} worker -I info`

workerì™€ beat ëª¨ë‘ ì‹¤í–‰  
`celery -A {file name}  worker -l info -B `
celery-beat : ì£¼ê¸°ì ìœ¼ë¡œ íŠ¹ì • í”„ë¡œì„¸ìŠ¤ë¥¼ ë™ì‘ì‹œí‚¤ê¸° ìœ„í•œ íŒ¨í‚¤ì§€

-A: application ( = -app )  => í™•ì¥ìë¥¼ ì œì™¸í•˜ê³  ì…ë ¥í•¨. ë§Œì•½ tasks.py ì´ë©´ tasksë¥¼ ì…ë ¥

worker ëŠ” ê¸°ë³¸ ëª…ë ¹ì–´ì´ë©° worker ì„œë²„ë¥¼ êµ¬ë™í•˜ë¼ëŠ” ëœ»ì´ë‹¤.


## schedule

```python
from celery.schedules import crontab
 
@app.task(bind=True)
def debug_task(self):
    print('Request: {0!r}'.format(self.request))
 
app.conf.beat_schedule = {
    'add-every-minute-contrab': {
        'task': 'multiply_two_numbers',
        'schedule': crontab(),  # 1ë¶„ë§ˆë‹¤
        'args': (16, 16),
    },
    'add-every-5-seconds': {
        'task': 'multiply_two_numbers',
        'schedule': 5.0,  # 5ì´ˆë§ˆë‹¤
        'args': (16, 16)
    },
    'add-every-30-seconds': {
        'task': 'tasks.add',
        'schedule': 30.0, # 30ì´ˆë§ˆë‹¤
        'args': (16, 16)
    },
}
```

## Celery monitor Tool
*Flower*
`pip install flower`  

- ì‘ì—… í”„ë¡œì„¸ìŠ¤ ìƒíƒœ
- ì‘ì—… í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ë‹¤ì‹œì‹œì‘
- ë””í…Œì¼í•œ API ê´€ë¦¬
- Celery Monitoring

ëª…ë ¹ì–´  
`celery -A {file name} flower --address=localhost --port=5555`

## Redis
`apt install redis-server` ì„¤ì¹˜
`apt install redis-cli` ì„¤ì¹˜

`redis-cli ping` >> PONG  
ì—°ê²° ì„±ê³µ  

# Blocker
flask form dataë¥¼ ë°›ëŠ” ê³¼ì •ì—ì„œ ì§ë ¬í™”ê°€ ì•ˆë˜ì–´ì„œ taskë¥¼ ì „ë‹¬í•˜ì§€ ëª»í•˜ëŠ” ìƒí™©ì´ ìˆì—ˆë‹¤  
form dataëŠ” `werkzeug.datastructures.FileStorage`ë¡œ ì„œë²„ë¡œ ì „ë‹¬ì´ ë˜ì—ˆëŠ”ë° í•´ë‹¹ ë°ì´í„° ì¤‘ FileStorage.streamì´ ì§ë ¬í™”ê°€ ë¶ˆê°€ëŠ¥í•˜ì˜€ë‹¤  
*_io.ByteIO ObjectëŠ” pickle, json ì§ë ¬í™”ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤*  
ë°ì´í„° ê°ì²´ë¥¼ ë¶„í•´ì‹œí‚¨ ë’¤ `FileStorage.stream.read()`ë¡œ ì´ì§„í˜•ì‹ìœ¼ë¡œ ë°”ê¾¼ë’¤ í˜•íƒœë“¤ì„ ë”•ì…”ë„ˆë¦¬ë¡œ ë°”ê¿” ì „ë‹¬ì„ í•˜ì˜€ë”ë‹ˆ ë¬¸ì œì—†ì´ í•´ê²°ì„ í•˜ì˜€ë‹¤  
task í•¨ìˆ˜ê°€ ë°›ìœ¼ë©´ streamì€ ë‹¤ì‹œ io.BytesIO(fileStream)ìœ¼ë¡œ BytesIO ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ FileStorage ê°ì²´ë¡œ ê²°í•©ì„ ì‹œì¼°ë‹¤  

*main.py*
```python
.
.
.

format = {
        'stream': file.stream.read(),
        'name': file.name,
        'filename': file.filename,
        'content_type': file.content_type,
        'content_length': file.content_length,
        'headers': {header[0]: header[1] for header in file.headers}
    }
```
<br>

*task.py*
```python
from io import BytesIO
from werkzeug.datastructures import FileStorage

.
.
.

file['stream'] = io.BytesIO(file['stream'])
filestorage = FileStorage(**file)

file = Path(filestorage.filename)            
```
[ì°¸ê³  ìë£Œ](https://newbedev.com/celery-task-in-flask-for-uploading-and-resizing-images-and-storing-it-to-amazon-s3)