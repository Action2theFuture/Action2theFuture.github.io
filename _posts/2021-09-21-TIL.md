---
layout: post
title: "DockerSwarm"
date: 2021-09-21
categories: TIL Docker-machine DockerSwarm
---

# Docker-machine

로컬컴퓨터가 배포된 도커와 버전이 다를경우 dockermachine을 통한 VM으로 개발을 할 수가 있다  
로컬컴퓨터가 의존적이지 않는 상황으로 만들어줌으로써 편리함을 제공해준다

지금은 Docker-machine을 지원하지 않는다 하지만 현재까지 개발과정에서는 많이 사용되고 있다
[Deprecated Engine Features | Docker Documentation](https://docs.docker.com/machine/)
[Deprecate Docker Machine · Issue](https://github.com/docker/roadmap/issues/245)

# DockerSwarm

## compose와 swarm 연결흐름

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmflow.jpg)

최소한 2개의 노드가 필요하다

하나의 노드는 manage(leader)노드이고 다른 하나는 worker노드로 설정하여  
EC2에 만들어 놓았다

각 노드 연결은 `2377 port`로 연결이 된다

## Docker swarm 과정

1. `docker swarm init`
   ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarminit1.png)  
   leader 노드에서 docker swarm을 초기화 및 실행을 시킨다

   - leader node 확인
     ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarminit.png)

2. `docker swarm init`을 실행하면 `docker swarm join --token ~~`이 출력이 된다 이것을 복사하여 worker 노드에 붙여넣고 실행을 한다
   ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarmjoin1.png)
   - worker node 확인
     ![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/dockerswarmjoin.png)
3. `docker stack deploy -c docker-compose.yml web`으로 docker swarm을 실행한다

```
Creating service web_{docker_service}
Creating service web_{docker_service2}
```

### docker-compose.yml

```
version: "3"

services:
  server:
    # docekrfile 경로
    image: tree0204/drf_tuto:latest
    # build 경로
    build: ./
    volumes:
      - ./:/usr/src/app
    command:
      - bash
      - -c
      - |
        python manage.py collectstatic --no-input
        python manage.py migrate
    ports:
      - 8000:8000
    depends_on:
      - sqlite3
    # docker swarm이 deploy부분을 읽고 실행한다
    deploy:
      placement:
        # 해당 노드 역할 부여
        constraints:
          - node.role==manager
      # 3개의 서버를 돌린다
      replicas: 3
      resources:
        limits:
          # 서버를 실행하는 것은 0.1초로 두고 memory는 20Mb으로 설정
          cpus: "0.1"
          memory: 20M
      # 서버가 다운이 되면 대체될 예비 컨테이너들을 설정을 해준다
      restart_policy:
        condition: on-failure
        delay: 2s
        max_attempts: 3

  sqlite3:
    image: nouchka/sqlite3:latest
    stdin_open: true
    tty: true
    volumes:
      - ./:./db.sqlite3
    deploy:
      replicas: 3
```

현재 해당 docker-compose를 실행하면서 문제점이 발생하였는데
한 노드로만 실행을 할 때는 문제가 없던 게 클러스터를 사용하니 경로문제가 발생하였다  
volue의 경로에 대한 에러가 발생하였는데 해당 에러내용은 이렇다

![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror.png)
![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror2.png)
![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror3.png)
![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror4.png)
![](https://raw.githubusercontent.com/Action2theFuture/Action2theFuture.github.io/main/_posts/Images/swarmerror5.png)

## 기타 명령어

- 모든 Docker service의 상황 출력
  `docker service ls`
- Docker service의 상황 출력
  `docker service ps {service_name}`
- Docker service의 에러사항을 포맷팅으로 출력  
   `docker service ps --format "{{.Error}}" {service_name}`
- Docker service 검사
  `docker service inspect {service_name}`
- Docker service 로그 확인
  `docker service logs {service_name}`
- Docker service 삭제
  `docker service rm {service_name}`
- Docker service 업데이트
  `docker service update`
